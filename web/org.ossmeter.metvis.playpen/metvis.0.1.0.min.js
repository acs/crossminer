/*! metvis 2015-02-14 */
var metvis={version:"0.0.1"};!function(){"use strict";metvis.Annotation=function(a,b,c){this.axis=a,this.intersect=b,this.label=c},metvis.Table=function(a,b){return self=this,self.container=a,self.vis=b,this.draw=function(){if("Table"!=self.vis.type)return void console.log("Invalid visualisation type. Should be 'Table'. For non-tabular data use metvis.Chart.draw().");$(self.container).append("<table></table>");var a=$(self.container).children(),b="<thead>";$.each(self.vis.datatable[0],function(a){b=b+"<th>"+a+"</th>"}),b+="</thead>",a.append(b);var c="<tbody>";$.each(self.vis.datatable,function(a,b){c+="<tr>",$.each(b,function(a,b){c=c+"<td>"+b+"</td>"}),c+="</tr>"}),c+="</tbody>",a.append(c)},this},metvis.Chart=function(a,b){var c=this;return c.container=a,c.vis=b,c.vises=[b],c.series=[],c.maximumVisualisations=3,c.axes=[],c.xScale=null,c.yScale=null,c.axis={},c.axis.y={},c.axis.y.ticks=10,c.axis.y.tickLabels=!0,c.axis.x={},c.axis.x.ticks=10,c.axis.x.tickLabels=!0,c.legend={},c.margin={top:60,right:20,bottom:30,left:50},c.dateFormat="%Y%m%d",c.colors=d3.scale.category20(),c._g,c.svg,c.annotations=[],c._drawn=!1,c.width=$(a).width(),c.height=$(a).height(),c.interactive=!1,this.draw=function(){if(c._drawn)return void console.err("draw() invoked multiple times. Only call once, then use redraw()");c._drawn=!0,c.width=c.width-c.margin.left-c.margin.right,c.height=c.height-c.margin.top-c.margin.bottom,c._formatData(c.vis),c._updateScales();var a=c._createAxis(c.xScale,"bottom",10),b=c._createAxis(c.yScale,"left",5);c.axes.push(a),c.axes.push(b);var d=c._extractSeries(c.vis);for(var e in d)c.series.push(d[e]);c.zoom=d3.behavior.zoom().x(c.xScale).y(c.yScale).scaleExtent([1,10]).on("zoom",function(){$(c.container).empty(),c.svg.select(".x.axis").call(c.axes[0]),c.svg.select(".y.axis").call(c.axes[1]),c._draw()}),c._draw()},c._draw=function(){c.svg=d3.select(a).append("svg").attr("width",c.width+c.margin.left+c.margin.right).attr("height",c.height+c.margin.top+c.margin.bottom).append("g").attr("transform","translate("+c.margin.left+","+c.margin.top+")"),c._drawGridlines(c.xScale,c.yScale);for(var b in c.series)c._drawSeries(c.series[b],c.colors(b));var d=c._createAxis(c.xScale,"bottom",c.axis.x.ticks),e=c._createAxis(c.yScale,"left",c.axis.y.ticks);c.vis.timeSeries&&d.tickFormat(c.dateAxisFormat),c.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+c.height+")").call(d),c.svg.append("g").attr("class","y axis").call(e),c.svg.append("g").attr("id","ossplots-annotations").attr("class","threshold-line"),d3.select("#ossplots-annotations").selectAll("line").data(c.annotations).enter().append("line").attr("x1",function(a){return"X"==a.axis?c.xScale(d3.time.format(c.dateFormat).parse(a.intersect)):c.axes[0].scale().range()[0]}).attr("x2",function(a){return"X"==a.axis?c.xScale(d3.time.format(c.dateFormat).parse(a.intersect)):c.axes[0].scale().range()[1]}).attr("y1",function(a){return"X"==a.axis?c.axes[1].scale().range()[0]:c.yScale(a.intersect)}).attr("y2",function(a){return"X"==a.axis?c.axes[1].scale().range()[1]:c.yScale(a.intersect)}),d3.select("#ossplots-annotations").selectAll("text").data(c.annotations).enter().append("text").text(function(a){return a.label}).attr("class","metvis-annotation-text").attr("x",function(a){return"X"==a.axis?c.xScale(d3.time.format(c.dateFormat).parse(a.intersect)):c.axes[0].scale().range()[0]}).attr("y",function(a){return"X"==a.axis?c.axes[1].scale().range()[1]:c.yScale(a.intersect)}),c.interactive&&(c.svg.call(c.zoom),"BarChart"===c.vis.type)},c._createAxis=function(a,b,c){return d3.svg.axis().scale(a).orient(b).ticks(c)},c.addAnnotation=function(a){if("undefined"==typeof a.axis||"undefined"==typeof a.intersect||"undefined"==typeof a.label)throw"Invalid annotation";c.annotations.push(a),$(c.container).empty(),c._draw()},c.removeAnnotation=function(a){var b=c.annotations.indexOf(a);b>=0&&(c.annotations.splice(b,1),$(c.container).empty(),c._draw())},c._drawSeries=function(a,d){if("Table"===a.vis.type)console.err("Attempted to draw a 'Table' series. Use metvis.Table.draw() for tabular data.");else if("LineChart"===a.vis.type)c.svg.append("g").append("path").attr("class","line").attr("d",a.line(a.vis.datatable)).style("stroke-width",1).style("stroke",d);else if("BarChart"===a.vis.type){var e=0;if(c.vis.timeSeries){var f=c.xScale.domain()[0],g=c.xScale.domain()[1],h=Math.ceil(g.getTime()-f.getTime())/864e5;e=(c.width-c.margin.left-c.margin.right)/(h+1)}else e=(c.width-c.margin.left-c.margin.right)/c.vis.datatable.length;var i=c.svg.selectAll("rect").data(a.vis.datatable).enter().append("rect").attr("x",function(d){return b.timeSeries?c.xScale(d[a.vis.x])-e/2:c.xScale(d[a.vis.x])}).attr("y",function(b){return c.yScale(b[a.vis.y]<0?0:b[a.vis.y])}).attr("width",function(){return a.vis.categorical?c.xScale.rangeBand():e}).attr("height",function(b){return b[a.vis.y]<0?Math.abs(c.yScale(0)-c.yScale(b[a.vis.y])):c.height-c.yScale(b[a.vis.y])}).attr("fill",function(b){return b[a.vis.y]<0?"red":d}).attr("opacity",.7).attr("title",function(b){return b[a.vis.x]});c.interactive&&i.on("mouseover",function(a){{var d=a[b.x]+": "+a[b.y];c.svg.append("text").text(d).attr("x",c.width/2).attr("y",c.height+c.margin.bottom-10).attr("class","metvis data-hover-label").style("text-anchor","middle")}}).on("mouseout",function(){c.svg.select(".metvis.data-hover-label").remove()})}else"ScatterChart"===a.vis.type&&c.svg.append("g").selectAll("circle").data(a.vis.datatable).enter().append("circle").attr("r",2).attr("cx",function(b){return c.xScale(b[a.vis.x])}).attr("cy",function(b){return c.yScale(b[a.vis.y])}).style("fill",d)},c._updateScales=function(){for(var a in c.vises)if(c.vises[a].timeSeries&&c.vises[a].categorical)throw"Data cannot be both categorical and time series.";var b=[];for(var a in c.vises){var d=c.vises[a];d.datatable.forEach(function(a){b.push(a[d.x])})}if(c.vis.timeSeries){var e=d3.extent(c.vis.datatable,function(a){return a[d.x]}),f=[d3.time.day.offset(e[0],-1),d3.time.day.offset(e[1],1)];c.xScale=d3.time.scale().rangeRound([0,c.width]),c.xScale.domain(f)}else c.vis.categorical?(c.xScale=d3.scale.ordinal().rangeRoundBands([0,c.width],.1),c.xScale.domain(b)):(c.xScale=d3.scale.linear().range([0,c.width]),c.xScale.domain(d3.extent(b)));var g=[];for(var a in c.vises){var d=c.vises[a];d.datatable.forEach("string"==typeof d.y?function(a){g.push(a[d.y])}:function(a){for(var b in d.y)g.push(a[d.y[b]])})}c.yScale=d3.scale.linear().range([c.height,0]),c.vis.timeSeries?c.yScale.domain(d3.extent(g)).nice():c.vis.categorical?c.yScale.domain([Math.min(0,d3.min(g)),d3.max(g)]):c.yScale.domain(d3.extent(g)).nice()},c._extractSeries=function(a){if("string"==typeof a.y){if(a.series){var b={};a.datatable.forEach(function(c){var d=c[a.series];if(!b[d]){b[d]=[];var e={};for(var f in a)"datatable"!=f&&(e[f]=a[f]);e.parentVis=a,e.datatable=[],b[d]=e}b[d].datatable.push(c)});var d=[];for(var e in b){var f=b[e],g=function(a){return d3.svg.line().x(function(b){return c.xScale(b[a.x])}).y(function(b){return c.yScale(b[a.y])})}(f,j),h={line:g,vis:f,name:e};d.push(h)}return d}var g=function(a){return d3.svg.line().x(function(b){return c.xScale(b[a.x])}).y(function(b){return c.yScale(b[a.y])})}(a,j),d={line:g,vis:a,name:a.y};return[d]}var i=[];for(var j in a.y){var g=function(a,b){return d3.svg.line().x(function(b){return c.xScale(b[a.x])}).y(function(d){return c.yScale(d[a.y[b]])})}(a,j),d={line:g,vis:a,name:a.y[j]};i.push(d)}return i},c.addVis=function(a){if(c.vis.timeSeries!=a.timeSeries||c.vis.categorical!=a.categorical)throw"Incompatible data types, cannot overlay data.";if($(c.container).empty(),-1===c.vises.indexOf(a)){c.vises.push(a),c._formatData(a),c._updateScales();var b=c._extractSeries(a);for(var d in b)c.series.push(b[d]),c._drawSeries(b[d],"red")}c._draw()},c.removeVis=function(b){$(a).empty();var d=c.vises.indexOf(b);if(-1!=d){c.vises.splice(d,1),c._updateScales();var e=[];for(var f in c.series)(c.series[f].vis===b||c.series[f].vis.parentVis===b)&&e.push(c.series[f]);if(0!=e.length)for(var g in e){var d=c.series.indexOf(e[g]);c.series.splice(d,1)}}c._draw()},c._formatData=function(a){var b=d3.time.format(c.dateFormat).parse;a.datatable.forEach(function(c){if(a.timeSeries===!0&&"string"==typeof c[a.x]?c[a.x]=b(c[a.x]):!a.categorical==!0&&(c[a.x]=+c[a.x]),"string"==typeof a.y)c[a.y]=+c[a.y];else for(var d in a.y)c[a.y[d]]=+c[a.y[d]]})},c._drawGridlines=function(a,b){c.svg.selectAll("line.y").data(b.ticks(5)).enter().append("line").attr("class","y grid").attr("x1",0).attr("x2",c.width).attr("y1",b).attr("y2",b)},this}}();